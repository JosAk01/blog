<%- include('partials/header'); -%>

<style>
  .main-content {
    margin-left: 0;
    padding: 30px;
    min-height: calc(100vh - 90px);
    background: #f8f9fc;
    max-width: 1400px;
    margin: 0 auto;
  }

  .calendar-header {
    background: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    margin-bottom: 24px;
  }

  .calendar-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .calendar-header h1 {
    font-size: 28px;
    font-weight: 800;
    color: #0b1020;
    margin: 0;
  }

  .calendar-actions {
    display: flex;
    gap: 12px;
  }

  .btn-calendar {
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary-calendar {
    background: linear-gradient(135deg, #5a5df5, #9a6bff);
    color: white;
    box-shadow: 0 4px 12px rgba(90, 93, 245, 0.3);
  }

  .btn-primary-calendar:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(90, 93, 245, 0.4);
  }

  .btn-secondary-calendar {
    background: white;
    color: #5c6074;
    border: 1px solid #e9eaf3;
  }

  .btn-secondary-calendar:hover {
    background: #f8f9fc;
  }

  .calendar-nav {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .month-year {
    font-size: 20px;
    font-weight: 700;
    color: #0b1020;
    min-width: 180px;
    text-align: center;
  }

  .nav-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 1px solid #e9eaf3;
    background: white;
    cursor: pointer;
    display: grid;
    place-items: center;
    transition: all 0.3s;
  }

  .nav-btn:hover {
    background: #5a5df5;
    color: white;
    border-color: #5a5df5;
  }

  .calendar-container {
    background: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 8px;
  }

  .weekday {
    text-align: center;
    font-weight: 700;
    font-size: 14px;
    color: #5c6074;
    padding: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
  }

  .calendar-day {
    aspect-ratio: 1;
    border: 1px solid #e9eaf3;
    border-radius: 12px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    background: white;
  }

  .calendar-day:hover {
    border-color: #5a5df5;
    background: #f8f9fc;
    transform: scale(1.05);
  }

  .calendar-day.today {
    background: linear-gradient(135deg, #5a5df5, #9a6bff);
    color: white;
    border-color: transparent;
  }

  .calendar-day.today:hover {
    transform: scale(1.05);
  }

  .calendar-day.other-month {
    opacity: 0.3;
    pointer-events: none;
  }

  .calendar-day.has-event {
    border-color: #5a5df5;
    background: #eef0ff;
  }

  .calendar-day.has-event::after {
    content: '';
    position: absolute;
    bottom: 8px;
    width: 6px;
    height: 6px;
    background: #5a5df5;
    border-radius: 50%;
  }

  .calendar-day.today.has-event::after {
    background: white;
  }

  .day-number {
    font-weight: 700;
    font-size: 16px;
    margin-bottom: 4px;
  }

  .day-events {
    font-size: 10px;
    color: #5c6074;
  }

  .calendar-day.today .day-events {
    color: white;
  }

  /* Events Panel */
  .events-panel {
    background: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    margin-top: 24px;
  }

  .events-panel h2 {
    font-size: 20px;
    font-weight: 700;
    color: #0b1020;
    margin-bottom: 16px;
  }

  .event-item {
    padding: 16px;
    border-left: 4px solid #5a5df5;
    background: #f8f9fc;
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .event-item h3 {
    font-size: 16px;
    font-weight: 700;
    color: #0b1020;
    margin-bottom: 4px;
  }

  .event-item p {
    font-size: 14px;
    color: #5c6074;
    margin: 0;
  }

  .event-time {
    font-size: 12px;
    color: #98a2b3;
    margin-top: 8px;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: white;
    padding: 32px;
    border-radius: 16px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    margin-bottom: 24px;
  }

  .modal-header h2 {
    font-size: 24px;
    font-weight: 700;
    color: #0b1020;
    margin: 0;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    color: #0b1020;
    margin-bottom: 8px;
    font-size: 14px;
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #e9eaf3;
    border-radius: 8px;
    font-size: 14px;
  }

  .form-group textarea {
    min-height: 100px;
    resize: vertical;
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
  }

  @media (max-width: 768px) {
    .calendar-header-top {
      flex-direction: column;
      gap: 16px;
    }

    .calendar-actions {
      width: 100%;
      flex-direction: column;
    }

    .btn-calendar {
      width: 100%;
      justify-content: center;
    }

    .day-events {
      display: none;
    }
  }
</style>

<div class="main-content">
  <div class="calendar-header">
    <div class="calendar-header-top">
      <h1><i class="uil uil-calendar-alt"></i> Calendar</h1>
      <div class="calendar-actions">
        <% if (session.user.role !== 'user') { %>
          <button class="btn-calendar btn-primary-calendar" id="addEventBtn">
            <i class="fas fa-plus"></i> Add Event
          </button>
        <% } %>
        <button class="btn-calendar btn-secondary-calendar" id="todayBtn">
          <i class="fas fa-calendar-day"></i> Today
        </button>
      </div>
    </div>

    <div class="calendar-nav">
      <button class="nav-btn" id="prevMonth">
        <i class="fas fa-chevron-left"></i>
      </button>
      <div class="month-year" id="monthYear"></div>
      <button class="nav-btn" id="nextMonth">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <div class="calendar-container">
    <div class="calendar-weekdays">
      <div class="weekday">Sun</div>
      <div class="weekday">Mon</div>
      <div class="weekday">Tue</div>
      <div class="weekday">Wed</div>
      <div class="weekday">Thu</div>
      <div class="weekday">Fri</div>
      <div class="weekday">Sat</div>
    </div>
    <div class="calendar-days" id="calendarDays"></div>
  </div>

  <div class="events-panel">
    <h2>Upcoming Events</h2>
    <div id="eventsList">
      <div class="event-item">
        <h3>Sample Event</h3>
        <p>This is a sample event to show how events appear in the calendar.</p>
        <p class="event-time"><i class="fas fa-clock"></i> Today at 2:00 PM</p>
      </div>
    </div>
  </div>
</div>

<!-- Add Event Modal -->
<div class="modal" id="eventModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add New Event</h2>
    </div>
    <form id="eventForm">
      <div class="form-group">
        <label>Event Title</label>
        <input type="text" id="eventTitle" required placeholder="e.g., Team Meeting" />
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="eventDescription" placeholder="Event details..."></textarea>
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="eventDate" required />
      </div>
      <div class="form-group">
        <label>Time</label>
        <input type="time" id="eventTime" required />
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-calendar btn-secondary-calendar" id="cancelEventBtn">
          Cancel
        </button>
        <button type="submit" class="btn-calendar btn-primary-calendar">
          <i class="fas fa-save"></i> Save Event
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentDate = new Date();
  let events = JSON.parse(localStorage.getItem('calendarEvents') || '[]');

  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];

  function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    const calendarDays = document.getElementById('calendarDays');
    calendarDays.innerHTML = '';
    
    const today = new Date();
    const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
    
    // Previous month days
    for (let i = firstDay - 1; i >= 0; i--) {
      const day = daysInPrevMonth - i;
      const dayElement = createDayElement(day, true, year, month - 1);
      calendarDays.appendChild(dayElement);
    }
    
    // Current month days
    for (let day = 1; day <= daysInMonth; day++) {
      const isToday = isCurrentMonth && day === today.getDate();
      const dayElement = createDayElement(day, false, year, month, isToday);
      calendarDays.appendChild(dayElement);
    }
    
    // Next month days
    const totalCells = calendarDays.children.length;
    const remainingCells = 42 - totalCells; // 6 rows * 7 days
    for (let day = 1; day <= remainingCells; day++) {
      const dayElement = createDayElement(day, true, year, month + 1);
      calendarDays.appendChild(dayElement);
    }
    
    renderEvents();
  }

  function createDayElement(day, isOtherMonth, year, month, isToday = false) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    if (isOtherMonth) dayElement.classList.add('other-month');
    if (isToday) dayElement.classList.add('today');
    
    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayEvents = events.filter(e => e.date === dateString);
    
    if (dayEvents.length > 0) {
      dayElement.classList.add('has-event');
    }
    
    dayElement.innerHTML = `
      <span class="day-number">${day}</span>
      ${dayEvents.length > 0 ? `<span class="day-events">${dayEvents.length} event${dayEvents.length > 1 ? 's' : ''}</span>` : ''}
    `;
    
    dayElement.addEventListener('click', () => {
      if (!isOtherMonth) {
        showDayEvents(dateString);
      }
    });
    
    return dayElement;
  }

  function renderEvents() {
    const eventsList = document.getElementById('eventsList');
    const now = new Date();
    const upcomingEvents = events.filter(e => new Date(e.date) >= now)
                                 .sort((a, b) => new Date(a.date) - new Date(b.date))
                                 .slice(0, 5);
    
    if (upcomingEvents.length === 0) {
      eventsList.innerHTML = '<p style="color: #5c6074; text-align: center; padding: 20px;">No upcoming events</p>';
      return;
    }
    
    eventsList.innerHTML = upcomingEvents.map(event => `
      <div class="event-item">
        <h3>${event.title}</h3>
        <p>${event.description || 'No description'}</p>
        <p class="event-time">
          <i class="fas fa-calendar"></i> ${new Date(event.date).toLocaleDateString('en-US', { 
            month: 'short', day: 'numeric', year: 'numeric' 
          })}
          <i class="fas fa-clock" style="margin-left: 12px;"></i> ${event.time}
        </p>
      </div>
    `).join('');
  }

  function showDayEvents(date) {
    const dayEvents = events.filter(e => e.date === date);
    if (dayEvents.length > 0) {
      alert(`Events on ${date}:\n\n${dayEvents.map(e => `${e.title} at ${e.time}`).join('\n')}`);
    }
  }

  // Navigation
  document.getElementById('prevMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  });

  document.getElementById('nextMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  });

  document.getElementById('todayBtn').addEventListener('click', () => {
    currentDate = new Date();
    renderCalendar();
  });

  // Modal
  const modal = document.getElementById('eventModal');
  const addEventBtn = document.getElementById('addEventBtn');
  const cancelEventBtn = document.getElementById('cancelEventBtn');
  const eventForm = document.getElementById('eventForm');

  if (addEventBtn) {
    addEventBtn.addEventListener('click', () => {
      modal.classList.add('active');
      document.getElementById('eventDate').value = currentDate.toISOString().split('T')[0];
    });
  }

  cancelEventBtn.addEventListener('click', () => {
    modal.classList.remove('active');
    eventForm.reset();
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('active');
      eventForm.reset();
    }
  });

  eventForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const newEvent = {
      id: Date.now(),
      title: document.getElementById('eventTitle').value,
      description: document.getElementById('eventDescription').value,
      date: document.getElementById('eventDate').value,
      time: document.getElementById('eventTime').value
    };
    
    events.push(newEvent);
    localStorage.setItem('calendarEvents', JSON.stringify(events));
    
    modal.classList.remove('active');
    eventForm.reset();
    renderCalendar();
    
    alert('Event added successfully!');
  });

  // Initial render
  renderCalendar();
</script>